# 아키텍처

## InnoDB 스토리지 엔진

`InnoDB`는  MySQL의 스토리지 엔진 가운데 가장 많ㄹ이 사용되는 엔진
MySQL에서 사용할 수 있는 스토리지 엔진 중 거의 유일하게 `레코드 기반`의 잠금을 제공하며, 
때문에 `높은 동시성` 처리가 가능하고 `안정적`이며 `성능이 뛰어나다`.

`InnoDB` 의 모든 테이블은 기본적으로 `primary key`를 기준으로 클러스터링되어 저장.
즉 프라이머리 키 값의 순서대로 디스크에 저장된다는 뜻이며, 모든 세컨더리 인덱스는 레코드의 주소 대신 프라이머리
키의 값을 논리적인 주소로 사용한다.
 - 프라이머리 키를 이용한 레인지 스캔은 상당히 빨리 처리 될 수 있음

## MVCC
레코드 레벨의 트랜잭션을 지원하는 DBMS가 제공하는 기능

MySQL 시스템 변수에 설정된 격리 수준에 따라 다르다.

> `READ_UNCOMMITED` 의 경우 InnoDB 버퍼 풀이 현재 가지고 있는 변경된 데이터를 읽어 반환

> `READ_COMMITTED` 및 그 이상 (`REPEATABLE_READ`, `SERIALIZABLE`)인 경우에는
>  아직 커밋되지 않았기 때문에 `언두 로그` 영역의 데이터를 반환

### 언두 로그
InnoDB 스토리지 엔진은 트랜잭션과 격리 수준을 보장하기 위해 DML로 변경되기 이전 버전의 데이터를 별도로 백업
이렇게 백업된 데이터를 `언두 로그`라고 한다.
 - 트랜잭션 보장
   - 트랜잭션이 롤백되면서 트랜잭션 도중 변경된 데이터를 변경 전 데이터로 복구
 - 격리수준 보장
   - 특정 커넥션에서 데이터를 변경하는 도중에 다른 커넥션에서 데이터를 조회하면 트랜잭션 격리 수준에 맞게 변경중인 레코드를 읽지 않고 언두 로그에 백업해둔 데이터를 읽어서 반환하기도 함

```sql
-- 언두 로그 건수 조회
SELECT count
  FROM information_schema.innodb_metrics
 WHERE SUBSYSTEM='transaction' AND NAME='trx_rseg_history_len';
```
참고 : `INSERT` 문에 대한 언두로그는 별도 저장, `UPDATE`, `DELETE` 문장에 대한 언두로그 개수만 표시됨

### 리두 로그
서버가 비정상적으로 종료됐을 때 데이터 파일에 기록되지 못한 데이터를 잃지 않게 해주는 안정장치
MySQL 서버에서 트랜잭션이 커밋돼도 데이터 파일은 즉시 디스크로 동기화되지 않는 반면, `리두 로그(트랜잭션 로그)`는 항상 디스크로 기록된다.
 - MySQL8.0 부터는 수동으로 리두 로그를 비활성화 하여 대용량 데이터의 적재 시간을 단축시킬 수 있음

